CREATE DATABASE QLBANHANG
GO
USE QLBANHANG
GO

CREATE TABLE CONGTY
(
MACONGTY CHAR(10) NOT NULL PRIMARY KEY, 
TENCONGTY NVARCHAR(30) NOT NULL,
DIACHI NVARCHAR(30) NOT NULL
)
GO

CREATE TABLE SANPHAM
(
MASANPHAM CHAR(10) NOT NULL PRIMARY KEY,
TENSANPHAM NVARCHAR(30) NOT NULL,
SOLUONGCO INT NOT NULL,
GIABAN MONEY NOT NULL
)
GO

CREATE TABLE CUNGUNG
(
MACONGTY CHAR(10) NOT NULL,
MASANPHAM CHAR(10) NOT NULL,
SLCUNGUNG INT NOT NULL,
NGAYCU DATETIME NOT NULL, 
PRIMARY KEY(MACONGTY, MASANPHAM)
)
GO

ALTER TABLE CUNGUNG ADD CONSTRAINT FK_MACONGTY FOREIGN KEY(MACONGTY)  REFERENCES CONGTY(MACONGTY)
ALTER TABLE CUNGUNG ADD CONSTRAINT FK_MASANPHAM FOREIGN KEY(MASANPHAM) REFERENCES SANPHAM(MASANPHAM)

INSERT INTO CONGTY VALUES
('1', 'ABC', N'HÀ NỘI'),
('2', 'BCD', N'HÀ NAM'),
('3', 'T&T', N'HÀ TĨNH')

INSERT INTO SANPHAM VALUES
('S1', N'ĐAU ĐẦU', 30, 30000),
('S2', N'ĐAU HỌNG', 80, 40000),
('S3', N'ĐAU RĂNG', 50, 25000)

INSERT INTO CUNGUNG VALUES
('1', 'S3', 100, '3/22/2021'),
('2', 'S2', 200, '3/23/2021'),
('3', 'S1', 300, '3/24/2021'),
('1', 'S2', 150, '3/25/2021'),
('2', 'S3', 90, '3/26/2021')



SELECT * FROM CONGTY
SELECT * FROM SANPHAM
SELECT * FROM CUNGUNG

-- CAU 2: TẠO 1 HÀM ĐƯA RA TENSP, MAUSAC, SOLUONG, GIABAN CỦA CÔNG TY VỚI TÊN 
-- CONG TY VÀ NGAYCUNGUNG NHAP TU BAN PHIM
CREATE FUNCTION SHOW(@TENCT NVARCHAR(30), @NGAYCU DATETIME) 
RETURNS @HIENTHI TABLE(TENSP NVARCHAR(30), SOLUONG INT, GIABAN MONEY)
AS
BEGIN
	INSERT INTO @HIENTHI
	SELECT SP.TENSANPHAM, SP.SOLUONGCO, SP.GIABAN
	FROM CUNGUNG AS CU INNER JOIN CONGTY AS CT ON CU.MACONGTY = CT.MACONGTY
		 INNER JOIN SANPHAM AS SP ON CU.MASANPHAM = SP.MASANPHAM
	WHERE CT.TENCONGTY = @TENCT AND CU.NGAYCU = @NGAYCU
	RETURN
END
--- TEST
SELECT * FROM CONGTY
SELECT * FROM CUNGUNG
SELECT * FROM SHOW('ABC', '3/25/2021')

--- CÂU 3: VIẾT THỦ TỤC THÊM MỚI 1 CÔNG TY VỚI MÃ CÔNG TY, TÊN CÔNG TY, ĐỊA CHỈ NHẬP TỪ BÀN PHÍM, NẾU
-- TÊN CÔNG TY ĐÓ TỒN TẠI TRƯỚC ĐÓ HÃY HIỂN THỊ THÔNG BÁO VÀ TRẢ VỀ 1, NGƯỢC LẠI CHO PHÉP THÊM MỚI VÀ TRẢ VỀ O

ALTER PROC SP_THEM_CT(@MACT CHAR(10), @TENCT NVARCHAR(30), @DIACHI NVARCHAR(30), @RESULT INT OUTPUT)
AS
BEGIN
	IF(EXISTS(SELECT * FROM CONGTY WHERE TENCONGTY = @TENCT))
	BEGIN
		PRINT(@MACT + 'TON TAI TRONG TABLE CONG TY')
		SET @RESULT = 1
	END
	ELSE
	BEGIN
		INSERT INTO CONGTY VALUES (@MACT, @TENCT, @DIACHI)
		SET @RESULT = 0
	END
	RETURN @RESULT
END

SELECT * FROM CONGTY
DECLARE @RESULT INT
EXEC SP_THEM_CT '3', 'ABC', 'HAI PHONG', @RESULT OUTPUT
SELECT @RESULT
SELECT * FROM CONGTY WHERE TENCONGTY = 'ABC'


--------------------------
CREATE TRIGGER CAU4 ON CUNGUNG
FOR UPDATE
AS
BEGIN
	DECLARE @SLCUMOI INT
	DECLARE @SLCUCU INT
	DECLARE @MASP CHAR(10)

	SELECT @MASP = MASANPHAM FROM inserted
	SELECT @SLCUMOI = SLCUNGUNG FROM INSERTED
	SELECT @SLCUCU = SLCUNGUNG FROM DELETED

	IF (@SLCUMOI - @SLCUCU) > (SELECT SOLUONGCO FROM SANPHAM WHERE MASANPHAM = @MASP)
		BEGIN
		RAISERROR('LOI', 16, 1)
		ROLLBACK TRANSACTION
		END
	ELSE
		IF (UPDATE(SLCUNGUNG))
			UPDATE SANPHAM SET SOLUONGCO = @SLCUMOI - @SLCUCU
			WHERE MASANPHAM = @MASP
END

SELECT * FROM SANPHAM
SELECT * FROM CUNGUNG

UPDATE CUNGUNG SET SLCUNGUNG = 220
WHERE MASANPHAM = 'S3'

UPDATE CUNGUNG
SET MACONGTY = '3'
WHERE NGAYCU = '3/25/2021'